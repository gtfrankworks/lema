---
title: Redis集群
createTime: 2025/08/26 13:33:24
permalink: /nosqldb/apr45ujb/
---
## 什么是 Redis 集群？

Redis 集群（Redis Cluster）是 Redis 官方提供的分布式解决方案，它允许你将数据自动分片（sharding）到多个 Redis 节点上，并提供高可用性。

与主从复制和哨兵模式不同，Redis 集群旨在解决**海量数据存储**的问题。它不仅提供了**自动故障转移**功能，还能让整个集群处理远超单个 Redis 实例的数据量和并发请求。

一个 Redis 集群由多个节点（Node）组成，每个节点都可以是主节点或从节点。

- **主节点：** 负责处理数据读写请求，并持有部分数据分片。
- **从节点：** 负责复制主节点的数据，提供数据冗余和故障转移支持。

## Redis 集群的工作原理

Redis 集群通过**哈希槽（Hash Slot）**机制来分配和管理数据。

### 1. 哈希槽（Hash Slot）

- Redis 集群将整个键空间（key space）划分为 16384 个哈希槽（0 到 16383）。
- 每个主节点负责管理其中一部分哈希槽。例如，一个三节点的集群，可能分配如下：
  - **主节点 A：** 负责哈希槽 0 到 5460
  - **主节点 B：** 负责哈希槽 5461 到 10922
  - **主节点 C：** 负责哈希槽 10923 到 16383
- 当客户端想要写入或读取一个 key 时，它会根据 `CRC16(key) % 16384` 的算法计算出该 key 属于哪个哈希槽，然后将请求发送到负责该哈希槽的主节点上。

### 2. 自动故障转移

- Redis 集群的每个节点都会持续与其他节点通信，以监控彼此的状态。
- 当一个主节点下线时，集群中的其他主节点会发现这个故障。
- 集群会自动从下线的该主节点的从节点中，选举出一个新的从节点来接替它的角色，成为新的主节点。这个过程是完全自动的，无需人工干预。

### 3. 数据重分片

- Redis 集群支持在线**扩容（Scale Out）和缩容（Scale In）**。
- 当需要增加节点时，可以向集群添加新的节点，并将部分哈希槽从现有节点迁移到新节点上。
- 当需要移除节点时，可以将其上的哈希槽迁移到其他节点，然后安全地移除该节点。

## Redis 集群的配置与搭建

搭建一个 Redis 集群需要至少 3 个主节点，通常每个主节点至少配备一个从节点，以保证高可用性。

**详细操作步骤和命令：**

为了方便演示，我们将在单台服务器上启动 6 个实例来模拟一个三主三从的集群。

### 1. 准备配置文件

创建 6 个配置文件，例如 `redis-7000.conf` 到 `redis-7005.conf`。每个配置文件都应包含以下基本配置：

```
port 7000  # 更改为对应端口
cluster-enabled yes
cluster-config-file nodes-7000.conf
cluster-node-timeout 5000
appendonly yes # 建议开启AOF持久化
daemonize yes # 后台运行
```

### 2. 启动所有实例

分别启动 6 个 Redis 实例。

```
redis-server redis-7000.conf
redis-server redis-7001.conf
redis-server redis-7002.conf
redis-server redis-7003.conf
redis-server redis-7004.conf
redis-server redis-7005.conf
```

### 3. 创建集群

使用 `redis-cli` 工具创建集群。我们将前三个节点设为主节点，后三个节点设为从节点。

```
# --cluster-replicas 1 表示每个主节点有一个从节点
# 127.0.0.1:7000, 7001, 7002 将被创建为主节点
# 127.0.0.1:7003, 7004, 7005 将自动作为从节点加入并复制对应的主节点
redis-cli --cluster create 127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 \
127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 --cluster-replicas 1
```

在执行命令时，会提示你是否接受集群配置，输入 `yes`。

### 4. 验证集群状态

连接到任一节点，查看集群信息。

```
redis-cli -p 7000
127.0.0.1:7000> CLUSTER INFO
# 查看集群中的所有节点和它们的角色
127.0.0.1:7000> CLUSTER NODES
```

## 案例说明：数据分片与故障转移

### 场景描述

你有一个社交应用，用户数据量巨大。为了应对高并发和大规模数据存储，你决定使用 Redis 集群来存储用户的个人信息和朋友圈动态。

### 解决方案

利用 Redis 集群的数据分片和高可用性功能，将用户数据分散到不同节点，并保障服务不中断。

**详细操作步骤和命令：**

1. **数据写入：**
   - 当你存储一个用户的个人信息时，客户端会自动计算 key 的哈希槽，并将其路由到正确的节点。
   - 假设用户 `user:1001` 的 key 被计算到哈希槽 `1234`，而该哈希槽由节点 `7000` 负责。
   - **命令：**
   - `redis-cli -c -p 7000` （-c 表示启用集群模式）
   - `127.0.0.1:7000> SET user:1001:name "Alice"`
   - `-> Redirected to slot 1234 located at 127.0.0.1:7000`
2. **主节点故障：**
   - 假设负责哈希槽 `0-5460` 的主节点 `7000` 突然下线。
   - **操作：** 强制关闭 `7000` 端口的 Redis 进程。
   - **故障转移过程：**
     1. 集群中的其他节点（如 `7001` 和 `7002`）会发现节点 `7000` 已经下线。
     2. 它们会选举出节点 `7000` 的从节点（假设是 `7003`）来接替它的角色。
     3. 节点 `7003` 会自动被提升为新的主节点，并继续处理哈希槽 `0-5460` 的请求。
   - **验证：**
   - `redis-cli -p 7001 cluster nodes`
   - 几秒后，你会看到节点 `7000` 的状态变为 `fail`，而节点 `7003` 的角色已变为 `master`。
3. **重新上线：**
   - 当 `7000` 节点重新启动后，它会自动作为新主节点 `7003` 的从节点加入集群，继续进行复制。

## 总结

Redis 集群是 Redis 应对大规模并发和数据存储的终极解决方案。它通过哈希槽的分布式机制，将数据均匀地分散到多个节点，实现了数据的水平扩展。同时，其内置的自动故障转移功能确保了服务的高可用性。

相较于哨兵模式，Redis 集群不仅提供了高可用性，更重要的是提供了**可扩展性**。当数据量和流量继续增长时，你可以轻松地向集群中添加更多节点，从而满足业务需求。