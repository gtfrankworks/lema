---
title: Redis哨兵模式
createTime: 2025/08/26 13:32:39
permalink: /nosqldb/uw7wxsph/
---
## 什么是 Redis 哨兵模式？

Redis 哨兵（Sentinel）是 Redis 官方推荐的高可用性解决方案。它是一个独立的进程，用于监控一个或多个 Redis 主从复制架构，并在主节点发生故障时自动执行故障转移（failover）。

- **主节点：** 负责所有读写操作。
- **从节点：** 只负责复制主节点的数据，处理读操作。
- **哨兵实例：** 监控主从节点，并在主节点下线时自动将一个从节点提升为新的主节点。

一个标准的 Redis Sentinel 架构由一个主节点、多个从节点和多个哨兵实例组成。

**哨兵模式的核心作用是实现自动故障转移。** 当主节点下线时，哨兵会自动将从节点提升为主节点，从而保证服务的高可用性，无需人工干预。

## 哨兵模式的工作原理

哨兵模式的工作原理可以分为三个阶段：监控、故障发现和故障转移。

### 1. 监控（Monitoring）

每个哨兵实例都会持续监控主节点和从节点。

- **主观下线（Subjectively Down）**：当一个哨兵实例在指定的时间内（`down-after-milliseconds`）没有收到主节点或从节点的有效响应时，它会认为该节点“主观下线”。这只是该哨兵自己的判断。
- **客观下线（Objectively Down）**：当足够多的哨兵实例（`quorum` 参数指定的数量）都认为主节点主观下线时，它们会共同达成一个共识，认为主节点“客观下线”。只有当主节点被判断为客观下线后，才会触发故障转移流程。

### 2. 故障发现（Failure Detection）

一旦主节点被判定为客观下线，哨兵实例之间会进行协商，选举出一个**领导者哨兵（Leader Sentinel）**。这个领导者哨兵将负责执行后续的故障转移。

### 3. 故障转移（Failover）

被选举为领导者的哨兵会执行以下步骤：

1. **选举新主节点**：从所有下线的从节点中，选择一个最优的从节点，将其提升为新的主节点。选择的依据通常包括：优先级（`replica-priority`）、复制偏移量（offset）等。
2. **执行 `REPLICAOF NO ONE`**：领导者哨兵向选出的从节点发送 `REPLICAOF NO ONE` 命令，使其停止复制，并晋升为新的主节点。
3. **重新配置其他从节点**：领导者哨兵向所有其他从节点发送 `REPLICAOF` 命令，让它们开始复制新的主节点。
4. **配置旧主节点**：如果旧的主节点重新上线，领导者哨兵会将其配置为新主节点的从节点，让其继续工作。

## 哨兵模式的配置

配置哨兵模式相对简单，通常需要配置一个或多个哨兵实例。

### 1. 启动主从复制架构

首先，需要像之前的文档中一样，启动一个主节点和至少一个从节点。

```
# 启动主节点（6379端口）
redis-server /path/to/master/redis.conf

# 启动从节点（6380端口）
redis-server /path/to/replica/redis.conf --replicaof 127.0.0.1 6379
```

### 2. 配置哨兵实例

创建一个 `sentinel.conf` 文件，并添加以下配置：

```
# 监控一个名为 'mymaster' 的主节点，其 IP 和端口为 127.0.0.1:6379
# 2 表示至少需要 2 个哨兵实例认为主节点下线，才会触发故障转移。
sentinel monitor mymaster 127.0.0.1 6379 2

# 指定哨兵实例在多长时间内没有收到主节点的响应，就认为其主观下线，单位为毫秒
sentinel down-after-milliseconds mymaster 5000

# 故障转移的超时时间
sentinel failover-timeout mymaster 60000

# 从节点晋升为新主节点的优先级。数字越小优先级越高，0表示不会被提升
# sentinel replica-priority mymaster 100
```

### 3. 启动哨兵实例

使用 `sentinel.conf` 文件来启动哨兵实例。

```
# 在不同的服务器上启动至少 3 个哨兵实例，以保证高可用性
redis-sentinel /path/to/sentinel/sentinel.conf
```

## 案例说明：自动故障转移

### 场景描述

你有一个 Redis 主从架构，由一个主节点（`127.0.0.1:6379`）和一个从节点（`127.0.0.1:6380`）组成。为了防止主节点宕机导致服务中断，你部署了三个哨兵实例来监控它们。

### 解决方案

当主节点意外宕机时，哨兵模式会自动执行故障转移，将从节点晋升为主节点，从而确保服务持续可用。

**详细操作步骤和命令：**

1. **初始状态：**
   - 启动主节点：`redis-server --port 6379`
   - 启动从节点：`redis-server --port 6380 --replicaof 127.0.0.1 6379`
   - 启动三个哨兵实例，使用 `sentinel.conf` 配置文件，其中 `quorum` 为 `2`。
   - **验证：**
   - `redis-cli -p 26379`
   - `127.0.0.1:26379> sentinel master mymaster`
   - `...role:master...`
2. **模拟主节点宕机：**
   - 强制关闭主节点进程（端口 `6379`）。
   - `killall redis-server` （如果你只有一个 Redis 实例）
   - 或者 `kill -9 <pid_of_master>`
3. **哨兵自动故障转移：**
   - 哨兵实例会立即检测到主节点下线。当两个哨兵都判定主节点主观下线后，会触发故障转移。
   - 哨兵会选举出领导者，并自动将从节点（`127.0.0.1:6380`）提升为新的主节点。
   - **验证：**
   - 几秒后，再次连接到新的主节点。
   - `redis-cli -p 6380`
   - `127.0.0.1:6380> INFO replication`
   - `# Replication...role:master`
   - 此时，旧的主节点（`6379`）已经下线，而 `6380` 端口的从节点已经接替了它的角色，并继续提供服务。

## 总结

Redis 哨兵模式是构建高可用 Redis 系统的基石。它通过自动监控、故障发现和故障转移机制，极大地提升了 Redis 服务的健壮性和可靠性，特别是在主节点发生意外故障时，可以最大限度地减少服务中断时间。

它解决了手动故障转移的痛点，是生产环境中 Redis 主从复制的必备伴侣。