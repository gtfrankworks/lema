---
title: Redis复制介绍
createTime: 2025/08/26 13:28:28
permalink: /nosqldb/t9mr66aj/
---
## 什么是 Redis 复制？

Redis 复制（Replication）是 Redis 的高可用性解决方案之一。它允许你将数据从一个 Redis 实例（**主节点，Master**）同步到一个或多个 Redis 实例（**从节点，Replica**）。

- **主节点（Master）：** 负责处理所有写请求（如 `SET`, `INCR`），并将数据变更同步给从节点。一个 Redis 复制架构中只有一个主节点。
- **从节点（Replica）：** 只负责处理读请求。从节点的数据是主节点的精确副本。一个主节点可以有多个从节点。

## 复制的工作原理

Redis 复制分为两种同步方式：**全量同步（Full Synchronization）和增量同步（Partial Synchronization）**。

### 1. 首次连接时的全量同步

当从节点首次连接到主节点时，会触发全量同步。这个过程确保从节点拥有主节点的完整数据副本。

1. **从节点发送 `PSYNC` 命令**：从节点向主节点发送 `PSYNC ? -1` 命令，表示请求全量同步。
2. **主节点开始 BGSAVE**：主节点收到请求后，会后台执行 `BGSAVE` 命令，生成一个 RDB 文件。
3. **主节点记录命令**：在 `BGSAVE` 期间，主节点会将所有新的写命令记录在一个**复制缓冲区（Replication Buffer）**中。
4. **传输 RDB 文件**：`BGSAVE` 完成后，主节点将生成的 RDB 文件发送给从节点。
5. **从节点加载 RDB**：从节点接收并加载 RDB 文件，从而获得与主节点相同的数据。
6. **传输复制缓冲区**：主节点将复制缓冲区中记录的写命令发送给从节点。从节点执行这些命令，以追赶上主节点在 `BGSAVE` 期间的最新数据。

### 2. 断线重连后的增量同步

如果主从连接意外断开（如网络波动），当从节点重新连接时，会尝试进行增量同步。

1. **从节点发送 `PSYNC` 命令**：从节点向主节点发送 `PSYNC <master_replid> <offset>` 命令，其中 `<master_replid>` 是主节点的 ID，`<offset>` 是从节点已同步的命令偏移量。
2. **主节点检查**：主节点会检查从节点提供的偏移量，看其请求的命令是否仍在**复制积压缓冲区（Replication Backlog）**中。
   - **如果在：** 主节点只需将积压缓冲区中从断开点开始的命令发送给从节点即可。
   - **如果不在：** 说明断开时间太长，积压缓冲区的数据已被覆盖。此时，主节点会强制执行一次全量同步。

## 复制的配置步骤

Redis 复制的配置非常简单，通常只需要在从节点上进行配置。

### 步骤 1: 启动主节点

启动一个 Redis 实例作为主节点。默认情况下，所有 Redis 实例都是主节点。

```
redis-server /path/to/master/redis.conf
```

### 步骤 2: 启动从节点并配置复制

启动另一个 Redis 实例作为从节点，并在其配置文件中添加或使用 `REPLICAOF` 命令指定主节点。

#### 方式一：配置文件（推荐）

在从节点的 `redis.conf` 文件中添加以下配置：

```
# 开启复制，指定主节点的 IP 和端口
replicaof <master_ip> <master_port>
```

然后启动从节点：

```
redis-server /path/to/replica/redis.conf
```

#### 方式二：动态命令

在从节点启动后，通过 `redis-cli` 连接并执行 `REPLICAOF` 命令。

```
# 在从节点上执行
redis-cli
127.0.0.1:6379> REPLICAOF <master_ip> <master_port>
```

## 案例说明

### 案例一：读写分离和高可用性

Redis 复制最典型的应用场景是实现**读写分离**和提供**高可用性**。

**场景描述**

假设你有一个高并发的电商应用。在促销活动期间，商品的库存、订单状态等数据更新频繁，同时又有大量的用户请求查询商品详情。

- **写操作（Writes）：** 更新库存、创建订单等。
- **读操作（Reads）：** 查询商品信息、查看购物车等。

**解决方案**

我们可以使用 Redis 复制来搭建一个主从架构，将读和写请求分开处理。

**详细操作步骤和命令：**

1. **启动主节点：**
   - 在服务器 A 上，启动一个 Redis 实例，监听默认端口 `6379`。
   - `redis-server`
   - **验证：** 连接到主节点并写入数据。
   - `redis-cli -p 6379`
   - `127.0.0.1:6379> SET product:1001:stock 100`
2. **启动从节点：**
   - 在服务器 B 上，启动一个 Redis 实例，监听不同端口，并配置其为主节点的从节点。
   - `redis-server --port 6380 --replicaof <master_ip> 6379`
   - **验证：** 连接到从节点并尝试读取数据。
   - `redis-cli -p 6380`
   - `127.0.0.1:6380> GET product:1001:stock`
   - `"100"`
   - **注意：** 从节点只能读，尝试写入会失败。
   - `127.0.0.1:6380> SET new_key "new_value"`
   - `(error) READONLY You can't write against a read only replica.`
3. **读写分离：**
   - 在你的应用代码中，配置数据源。
   - **写操作：** 所有 `SET`, `HSET`, `LPUSH` 等命令，都发送到主节点 `127.0.0.1:6379`。
   - **读操作：** 所有 `GET`, `HGETALL`, `LRANGE` 等命令，都随机发送到从节点 `127.0.0.1:6380`。

**优点**

- **提升吞吐量**：将读写操作分散到不同的节点上，可以显著提高系统的并发处理能力。尤其是读请求量远大于写请求量时，效果更佳。
- **数据冗余**：从节点保存了主节点的数据副本。即使主节点发生故障，从节点仍然可以提供服务，保证了数据不丢失和业务的连续性。
- **故障转移（Failover）**：如果主节点宕机，可以手动（或通过 Sentinel、Cluster 自动）将一个从节点晋升为新的主节点，从而快速恢复服务。

### 案例二：数据持久化与故障恢复

除了高可用性，Redis 复制也是实现数据持久化和故障恢复的重要手段。

**场景描述**

你的应用对数据丢失零容忍。如果主节点因为服务器宕机或意外重启而关闭，你需要保证数据不会丢失。

**解决方案**

即使主节点没有开启 RDB 或 AOF 持久化，从节点也充当了数据的备份。

**详细操作步骤和命令：**

1. **模拟主节点宕机：**
   - 假设你的主节点正在运行，并已经同步了数据到从节点。
   - 使用 `kill` 命令强制关闭主节点进程。
   - `kill -9 <master_pid>`
   - **验证：** 连接主节点会失败。
   - `redis-cli -p 6379`
   - `Could not connect to Redis at 127.0.0.1:6379: Connection refused`
2. **从节点检查：**
   - 从节点此时仍然可用，但它会显示与主节点断开连接。
   - `redis-cli -p 6380`
   - `127.0.0.1:6380> INFO replication`
   - `# Replication...master_host:<master_ip>...master_link_status:down`
3. **手动恢复（将从节点晋升为主节点）：**
   - 在从节点上执行 `REPLICAOF NO ONE` 命令，让它停止复制，并晋升为一个新的主节点。
   - `127.0.0.1:6380> REPLICAOF NO ONE`
   - `OK`
   - **验证：** 现在这个从节点可以接受写请求了。
   - `127.0.0.1:6380> INFO replication`
   - `# Replication...role:master`
   - `127.0.0.1:6380> SET new_key "new_value"`
   - `OK`

**优点**

- **增强数据安全性**：复制提供了实时的数据冗余，即使主节点完全无法恢复，数据也已经在从节点上有了备份。
- **快速恢复**：通过手动或自动的方式，可以迅速将服务切换到从节点，大大缩短服务中断时间。

## 复制的注意事项

1. **数据一致性**：Redis 的复制是**异步**的。这意味着主节点执行完命令后会立即返回，而不会等待从节点同步完成。在网络延迟高的情况下，主从之间可能存在短暂的数据不一致。
2. **读请求分配**：在读写分离架构中，客户端需要智能地将读请求分发到从节点，将写请求分发到主节点。这通常需要由客户端或代理层来完成。
3. **主节点故障**：当主节点宕机时，如果没有 Sentinel 或 Cluster 这样的高可用组件，需要手动将一个从节点晋升为新的主节点，并让其他从节点连接到新主节点。