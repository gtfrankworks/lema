---
title: Redis 持久化详解
createTime: 2025/08/26 13:12:11
permalink: /nosqldb/redises/qbr291jr/
---
Redis 提供了 **三种持久化策略**：

1. **RDB（快照持久化，Snapshotting）**
2. **AOF（日志持久化，Append Only File）**
3. **RDB + AOF 混合持久化（Hybrid Persistence，4.0+）**

------

## 1️⃣ RDB（快照持久化）

### 📍 原理

- Redis 会在某个时刻，把**内存中的数据以快照的形式保存到磁盘文件（dump.rdb）**。
- 本质上是一个 **全量备份**。

### 📍 触发方式

- **手动触发**：

  - `SAVE`：在主线程直接保存 RDB，**阻塞 Redis 服务**。
  - `BGSAVE`：fork 出子进程写 RDB 文件，主进程继续处理请求（常用）。

- **自动触发**：
   配置 `redis.conf`，满足条件时自动保存：

  ```
  save 900 1      # 900 秒内至少有 1 次写操作
  save 300 10     # 300 秒内至少有 10 次写操作
  save 60 10000   # 60 秒内至少有 10000 次写操作
  ```

- **特殊情况触发**：

  - 执行 `FLUSHALL`（清空数据）时会生成空 RDB。
  - Redis 关机时（`shutdown`），如果配置了 `save`，也会触发 `SAVE`。

### 📍 RDB 文件写入过程

1. Redis **fork** 子进程。
2. 子进程遍历内存数据，序列化写入临时文件（`temp.rdb`）。
3. 写入完成后替换旧的 `dump.rdb` 文件。

> 使用 **写时复制（Copy-On-Write, COW）机制**：
>  在 fork 后，子进程共享父进程的内存页；当父进程有写操作时，才复制内存页，避免大量复制，提高效率。

### 📍 优缺点

✅ 优点：

- RDB 文件小，适合全量备份、迁移。
- 恢复速度快（直接加载 RDB 文件到内存）。
   ❌ 缺点：
- 只能定时快照，**丢失上一次快照后的数据**。
- `BGSAVE` 时会 fork 子进程，内存翻倍，**大内存实例性能受影响**。

------

## 2️⃣ AOF（日志持久化）

### 📍 原理

- Redis 会把每条 **写命令（如 SET、HSET）** 追加到 AOF 文件（appendonly.aof）。
- 重启时，Redis 通过回放 AOF 文件里的命令，恢复数据。

### 📍 AOF 写入过程

1. **命令追加**：将写命令写入 AOF 缓冲区（内存）。
2. **同步写磁盘**：由 `appendfsync` 决定写盘策略：
   - `always`：每条命令都写盘（最安全，最慢）。
   - `everysec`（默认）：每秒写盘一次（最多丢 1 秒数据）。
   - `no`：由操作系统决定（写入频率不可控）。

### 📍 AOF 文件过大 → 重写（rewrite）

- 长期运行，AOF 文件会越来越大（包含所有历史命令）。
- Redis 提供 **重写机制**：
  1. Fork 一个子进程，扫描内存中的数据。
  2. 生成一份新的 AOF 文件（用最少的命令集表示当前数据）。
  3. 新文件写好后替换旧的 AOF。

### 📍 触发方式

- 手动：`BGREWRITEAOF`。

- 自动：根据配置触发，比如：

  ```
  auto-aof-rewrite-min-size 64mb
  auto-aof-rewrite-percentage 100
  ```

  含义：AOF 文件大小超过 64MB 且比上次重写后大一倍时，触发重写。

### 📍 优缺点

✅ 优点：

- 数据更安全（丢失数据少，最多 1 秒）。
- AOF 日志可读性强，容易做数据恢复。
   ❌ 缺点：
- 文件比 RDB 大，恢复速度慢。
- 重写过程也需要 fork 子进程，占用内存。

------

## 3️⃣ RDB + AOF 混合持久化（Redis 4.0+）

### 📍 原理

- **AOF 重写时**，不再只写纯命令，而是在新 AOF 文件的开头写一份 **RDB 快照**。
- 后续再追加增量命令。

这样恢复时：

1. 先加载 RDB 部分（快速恢复大部分数据）。
2. 再回放后续 AOF 命令（保证最新数据）。

### 📍 优缺点

✅ 优点：

- 结合 RDB（快速恢复）+ AOF（数据更完整）的优势。
- 适合生产环境。
   ❌ 缺点：
- 文件格式更复杂，兼容性要求高。

------

## 4️⃣ 性能与应用场景对比

| 持久化方式 | 数据安全性                   | 文件大小 | 恢复速度 | 性能影响           | 应用场景                   |
| ---------- | ---------------------------- | -------- | -------- | ------------------ | -------------------------- |
| RDB        | 中等（丢最后一次快照后数据） | 小       | 快       | 低（偶尔 BGSAVE）  | 全量备份、灾难恢复         |
| AOF        | 高（秒级丢失）               | 大       | 慢       | 中等（频繁写日志） | 高可靠性要求（订单、支付） |
| RDB+AOF    | 高（秒级丢失）               | 中等     | 较快     | 中等               | 生产环境推荐               |

------

## 5️⃣ 最佳实践建议

1. **生产环境推荐**：
    开启 **RDB + AOF 混合持久化**，兼顾性能与安全。
2. **仅做缓存**：
    可以关闭持久化，完全依赖内存（比如 CDN 缓存）。
3. **大内存实例（>50GB）**：
   - 使用 `BGSAVE` / `BGREWRITEAOF` 时注意 fork 开销。
   - 推荐使用 `lazy-free` 异步释放内存。
4. **定期备份 RDB 文件**：
   - 即使启用了 AOF，也建议周期性备份 RDB，用于灾备。

------

📌 **一句话总结**：

- **RDB**：轻量、快速，但不实时。
- **AOF**：更安全，但更重。
- **RDB + AOF**：性能与安全的最佳平衡，是 **生产环境推荐方案**。

# 📊 Redis 持久化机制流程图

```
                ┌───────────────────┐
                │   Redis 内存数据   │
                └─────────┬─────────┘
                          │
          ┌───────────────┼────────────────┐
          │                               │
   ┌──────▼───────┐               ┌───────▼───────┐
   │     RDB      │               │      AOF      │
   └──────┬───────┘               └───────┬───────┘
          │                               │
   ┌──────▼───────────────┐       ┌───────▼─────────────────────┐
   │ fork 子进程           │       │ 写命令 → AOF 缓冲区          │
   │ 写 dump.rdb 快照文件  │       │ appendfsync → 写入磁盘      │
   └───────────────┬──────┘       └───────────┬─────────────────┘
                   │                          │
          ┌────────▼────────┐         ┌───────▼───────────────┐
          │   恢复时直接载入 │         │ AOF 重写（fork 子进程） │
          │   dump.rdb 文件 │         │ 生成新 appendonly.aof  │
          └─────────────────┘         └───────────────────────┘


                   ┌─────────────────────┐
                   │   RDB + AOF 混合    │
                   └─────────┬──────────┘
                             │
        ┌────────────────────▼────────────────────┐
        │ AOF 文件 = RDB 快照 + 后续写命令         │
        │ 恢复时：先加载 RDB 部分，再回放命令      │
        └────────────────────────────────────────┘
```

------

这样你可以一眼看到：

- **RDB**：fork 子进程写快照，恢复快但可能丢数据。
- **AOF**：命令追加日志，数据更安全，但恢复慢。
- **混合模式**：先存 RDB 快照，再存命令，兼顾性能与安全。

